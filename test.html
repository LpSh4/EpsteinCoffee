<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Кофейное меню с вариациями</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0; background: #fefefe; color: #222;
    display: flex; flex-direction: column; min-height: 100vh;
  }
  header {
    background: #6f4e37;
    color: white; padding: 1rem; text-align: center;
    font-size: 1.5rem; font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  main {
    flex-grow: 1; display: flex; gap: 1rem;
    padding: 1rem; max-width: 1200px; margin: auto;
  }
  section {
    background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1rem; flex: 1;
    display: flex; flex-direction: column;
  }
  h2 {
    text-align: center; margin-top: 0; font-weight: 700; color: #5a3e2b;
  }
  #menu-list, #cart-list {
    flex-grow: 1; overflow-y: auto;
    padding: 0; margin: 0; list-style: none;
  }
  .menu__item, .cart__item {
    border-bottom: 1px solid #ddd; padding: 0.5rem 0; display: flex;
    gap: 0.8rem; align-items: center;
  }
  .menu__item:last-child, .cart__item:last-child {
    border-bottom: none;
  }
  .menu__img {
    width: 80px; height: 80px; object-fit: cover; border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    flex-shrink: 0;
  }
  .menu__details {
    flex-grow: 1;
  }
  .menu__item-title {
    font-weight: 700; margin: 0 0 0.2rem;
    color: #6f4e37;
  }
  .menu__item-description {
    font-size: 0.9rem; color: #666; margin: 0 0 0.5rem;
  }
  .menu__item-price {
    font-weight: 700; color: #bf6b40; margin-bottom: 0.4rem;
  }
  .menu__item-buttons {
    display: flex; flex-wrap: wrap; gap: 0.25rem;
  }
  button {
    border: none; border-radius: 5px; cursor: pointer;
    padding: 0.25rem 0.5rem;
    background: #6f4e37;
    color: white;
    font-size: 0.9rem;
    transition: background 0.3s ease;
  }
  button:hover, button:focus {
    background: #d2691e;
    outline: none;
  }
  .menu__btn-addon {
    background: #b28867;
    font-size: 0.8rem;
  }
  .menu__btn-addon.menu__btn-addon--active {
    background: #bf6b40;
    font-weight: 700;
  }
  .menu__btn-cart {
    background: #985f3a;
  }
  .menu__btn-order {
    background: #bf6b40;
  }
  .cart__item-info {
    flex-grow: 1; display: flex; flex-direction: column;
  }
  .cart__item-name {
    font-weight: 700; color: #6f4e37;
  }
  .cart__item-addons {
    font-size: 0.9rem; color: #936e57;
  }
  .cart__item-qty {
    margin-top: 0.4rem;
    display: flex; align-items: center; gap: 0.5rem;
  }
  .qty-btn {
    background: #d2691e;
    width: 24px; height: 24px;
    display: flex; justify-content: center; align-items: center;
    font-weight: 700;
    user-select: none;
  }
  .qty-number {
    min-width: 20px; text-align: center;
  }
  #cart-empty {
    margin-top: auto; margin-bottom: auto;
    text-align: center; color: #888;
    font-style: italic;
  }
  #cart-order-btn {
    margin-top: 0.5rem;
    width: 100%;
    font-size: 1rem;
    font-weight: 700;
  }
  #cart-count {
    background: #bf6b40;
    color: white;
    border-radius: 50%;
    padding: 0 7px;
    font-size: 0.8rem;
    position: absolute;
    top: 6px;
    right: 6px;
    display: none;
  }
</style>
</head>
<body>
<header>
  Кофейное меню с вариациями
  <div id="cart-count" aria-label="Количество товаров в корзине" role="status"></div>
</header>
<main>
  <section id="menu-section" aria-label="Меню">
    <h2>Меню</h2>
    <ul id="menu-list" tabindex="0" aria-live="polite"></ul>
  </section>
  <section id="cart-section" aria-label="Корзина">
    <h2>Корзина</h2>
    <ul id="cart-list" tabindex="0" aria-live="polite"></ul>
    <div id="cart-empty">Ваша корзина пуста.</div>
    <button id="cart-order-btn" aria-label="Оформить заказ">Просмотреть меню</button>
  </section>
</main>

<script>
  // Menu items data with id, name, description, price, and image
  const menuItems = [
    { id: 'espresso', name: 'Эспрессо', description: 'Крепкий и насыщенный классический эспрессо.', price: 120, image: 'content/images/espresso.jpg' },
    { id: 'latte', name: 'Латте', description: 'Мягкий кофе с молочной пеной и легкой сладостью.', price: 185, image: 'content/images/latte.jpg' },
    { id: 'cappuccino', name: 'Капучино', description: 'Баланс кофе, молока и пены — классика кофейной культуры.', price: 160, image: 'content/images/cappuccino.jpg' },
    { id: 'mocha', name: 'Мокко', description: 'Кофе с шоколадным сиропом и взбитыми сливками.', price: 190, image: 'content/images/mocha.jpg' },
    { id: 'americano', name: 'Американо', description: 'Яркий, но мягкий кофе на основе эспрессо и горячей воды.', price: 130, image: 'content/images/americano.jpg' },
    { id: 'ristretto', name: 'Ристретто', description: 'Очень концентрированный эспрессо с ярким вкусом.', price: 130, image: 'content/images/ristretto.jpg' },
    { id: 'flatwhite', name: 'Флэт Уайт', description: 'Кофе с бархатистой молочной пеной — идеален для любителей мягких вкусов.', price: 180, image: 'content/images/flatwhite.jpg' },
    { id: 'matchatea', name: 'Чай Матча', description: 'Японский зелёный чай в порошке, богатый антиоксидантами.', price: 210, image: 'content/images/motcha.jpg' },
    { id: 'glace', name: 'Глясе', description: 'Холодный кофе с мороженым и шоколадным сиропом.', price: 200, image: 'content/images/glace.jpg' },
    { id: 'brownie', name: 'Брауни с орео', description: 'Насыщенный шоколадный рецепт с хрустящей начинкой.', price: 100, image: 'content/images/brownie.jpg' },
    { id: 'pancakes', name: 'Панкейки с матча', description: 'Мягкие блинчики с зелёным акцентом.', price: 150, image: 'content/images/pancakes.jpg' },
    { id: 'croissant', name: 'Круассан с нутеллой', description: 'Французская классика с ореховой пастой.', price: 120, image: 'content/images/croissant.jpg' },
    { id: 'macaron', name: 'Макарон', description: 'Легкие, воздушные, яркие.', price: 90, image: 'content/images/macaron.jpg' },
    { id: 'donut', name: 'Боба-чай донат', description: 'Пончик с начинкой из боба.', price: 200, image: 'content/images/donut.jpg' },
    { id: 'eclair', name: 'Фисташковый эклер', description: 'Кремовый взрыв вкуса.', price: 250, image: 'content/images/eclair.jpg' }
  ];

  // Available addons with names and prices (85 rubles each)
  const addons = {
    chocolateSyrup: { name: 'Шоколадный сироп', price: 85 },
    pistachioMilk: { name: 'Фисташковое молоко', price: 85 },
    nonLactoseCream: { name: 'Безлактозные сливки', price: 85 }
  };

  // Cart structure:
  // cart = {
  //   itemId: [
  //     { qty: number, addons: { addonId: true/false } },
  //     ...
  //   ],
  //   ...
  // }
  let cart = {};

  // Current addon selections per item in menu (before adding to cart)
  let currentSelection = {};

  // DOM elements references
  const menuList = document.getElementById('menu-list');
  const cartList = document.getElementById('cart-list');
  const cartEmpty = document.getElementById('cart-empty');
  const cartOrderBtn = document.getElementById('cart-order-btn');
  const cartCount = document.getElementById('cart-count');

  // Save cart to localStorage for persistence across sessions
  function saveCart() {
    localStorage.setItem('coffeelike_cart', JSON.stringify(cart));
  }

  // Load cart from localStorage on page load
  function loadCart() {
    try {
      const saved = localStorage.getItem('coffeelike_cart');
      if (saved) {
        cart = JSON.parse(saved);
        if (typeof cart !== 'object' || cart === null) {
          cart = {};
        }
      }
    } catch (e) {
      console.error('Failed to load cart from localStorage:', e);
      cart = {};
    }
  }

  // Save currentSelection to localStorage (optional for persistence across reloads)
  function saveCurrentSelection() {
    localStorage.setItem('coffeelike_current_selection', JSON.stringify(currentSelection));
  }

  // Load currentSelection from localStorage
  function loadCurrentSelection() {
    try {
      const saved = localStorage.getItem('coffeelike_current_selection');
      if (saved) {
        currentSelection = JSON.parse(saved);
        if (typeof currentSelection !== 'object' || currentSelection === null) {
          currentSelection = {};
        }
      }
    } catch (e) {
      currentSelection = {};
    }
  }

  // Deep equality check for addons objects to determine if two addon sets match
  function addonsEqual(a, b) {
    const aKeys = Object.keys(a).filter(k => a[k]);
    const bKeys = Object.keys(b).filter(k => b[k]);
    if (aKeys.length !== bKeys.length) return false;
    aKeys.sort();
    bKeys.sort();
    for (let i = 0; i < aKeys.length; i++) {
      if (aKeys[i] !== bKeys[i]) return false;
    }
    return true;
  }

  // Render menu items with images, prices, buttons and addons selection state
  function renderMenu() {
    menuList.innerHTML = ''; // Clear existing menu
    menuItems.forEach(item => {
      const itemCurrentAddons = currentSelection[item.id] || {};
      const article = document.createElement('li');
      article.className = 'menu__item';
      article.setAttribute('data-id', item.id);

      // Build addon buttons with active states from currentSelection
      const addonButtonsHtml = Object.keys(addons).map(addonId => {
        const activeClass = itemCurrentAddons[addonId] ? 'menu__btn-addon--active' : '';
        return `<button class="menu__btn-addon ${activeClass}" data-id="${item.id}" data-addon="${addonId}" aria-pressed="${itemCurrentAddons[addonId] ? 'true' : 'false'}" aria-label="${itemCurrentAddons[addonId] ? 'Удалить' : 'Добавить'} ${addons[addonId].name} к ${item.name}">+ ${addons[addonId].name}</button>`;
      }).join(' ');

      article.innerHTML = `
        <img src="${item.image}" alt="${item.name}" class="menu__img" />
        <div class="menu__details">
          <h3 class="menu__item-title">${item.name}</h3>
          <p class="menu__item-description">${item.description}</p>
          <div class="menu__item-price">${item.price} ₽</div>
          <div class="menu__item-buttons">
            <button class="menu__btn-cart" data-id="${item.id}" aria-label="Добавить ${item.name} с выбранными добавками в корзину">В корзину</button>
            ${addonButtonsHtml}
          </div>
        </div>
      `;
      menuList.appendChild(article);
    });
  }

  // Update cart badge with total item count (sum of qty of all variants for all items)
  function updateCartBadge() {
    let totalCount = 0;
    for (const id in cart) {
      cart[id].forEach(variant => {
        totalCount += variant.qty;
      });
    }
    if (totalCount > 0) {
      cartCount.style.display = 'inline-block';
      cartCount.textContent = totalCount;
    } else {
      cartCount.style.display = 'none';
      cartCount.textContent = '';
    }
  }

  // Render cart showing each variant separately
  function renderCart() {
    cartList.innerHTML = '';
    let totalCartPrice = 0;
    let hasItems = false;

    for (const id in cart) {
      const item = menuItems.find(i => i.id === id);
      if (!item) continue;

      cart[id].forEach((variant, index) => {
        if (variant.qty <= 0) return;
        hasItems = true;

        const addonNames = Object.keys(variant.addons || {})
          .filter(addon => variant.addons[addon])
          .map(addon => addons[addon]?.name || addon);

        const addonText = addonNames.length > 0 ? `Добавки: ${addonNames.join(', ')}` : '';
        const addonPrice = Object.keys(variant.addons || {})
          .filter(addon => variant.addons[addon])
          .reduce((sum, addon) => sum + (addons[addon]?.price || 0), 0);

        const variantTotalPrice = (item.price + addonPrice) * variant.qty;
        totalCartPrice += variantTotalPrice;

        const li = document.createElement('li');
        li.className = 'cart__item';
        li.setAttribute('data-id', id);
        li.setAttribute('data-variant-index', index);

        li.innerHTML = `
          <div class="cart__item-info">
            <div class="cart__item-name">${item.name}</div>
            ${addonText ? `<div class="cart__item-addons">${addonText}</div>` : ''}
            <div class="cart__item-qty" aria-label="Количество ${item.name}">
              Количество:
              <button class="qty-btn decrement" aria-label="Уменьшить количество ${item.name} на 1">-</button>
              <span class="qty-number">${variant.qty}</span>
              <button class="qty-btn increment" aria-label="Увеличить количество ${item.name} на 1">+</button>
            </div>
          </div>
          <div>${variantTotalPrice} ₽</div>
        `;

        // Add keyboard accessibility for quantity buttons
        li.querySelectorAll('.qty-btn').forEach(btn => {
          btn.tabIndex = 0;
          btn.addEventListener('keypress', e => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              btn.click();
            }
          });
        });

        cartList.appendChild(li);
      });
    }

    if (!hasItems) {
      cartEmpty.style.display = 'block';
      cartOrderBtn.textContent = 'Просмотреть меню';
      cartOrderBtn.disabled = false;
    } else {
      cartEmpty.style.display = 'none';
      cartOrderBtn.textContent = `Оформить заказ (${totalCartPrice} ₽)`;
      cartOrderBtn.disabled = false;
    }
  }

  // Clear cart and reset badge
  function clearCart() {
    cart = {};
    saveCart();
    updateCartBadge();
    renderMenu(); // Refresh menu to clear current selections highlights
  }

  // Handle clicks on menu buttons (cart, addons)
  function handleMenuButtonClick(e) {
    const target = e.target;
    const id = target.dataset.id;
    if (!id) return;

    if (target.classList.contains('menu__btn-addon')) {
      // Toggle addon in currentSelection for this item id
      if (!currentSelection[id]) currentSelection[id] = {};
      const addonId = target.dataset.addon;
      currentSelection[id][addonId] = !currentSelection[id][addonId];
      // Save current selection and re-render menu
      saveCurrentSelection();
      renderMenu();
    } else if (target.classList.contains('menu__btn-cart')) {
      // Add one variant with currentSelection addons to cart under this id

      if (!cart[id]) cart[id] = [];

      const addonsSelected = currentSelection[id] || {};
      // Check if variant with same addons exists
      const variantIndex = cart[id].findIndex(variant => addonsEqual(variant.addons, addonsSelected));

      if (variantIndex !== -1) {
        // Increment qty
        cart[id][variantIndex].qty++;
      } else {
        // Add new variant
        cart[id].push({ qty: 1, addons: { ...addonsSelected } });
      }

      // Clear current selection for this item after adding to cart
      delete currentSelection[id];
      saveCurrentSelection();

      saveCart();
      updateCartBadge();
      renderMenu();
      renderCart();
    }
  }

  // Handle cart quantity changes (increment and decrement)
  function handleCartListClick(e) {
    const target = e.target;
    if (!target.closest('.cart__item')) return;

    const li = target.closest('.cart__item');
    const id = li.getAttribute('data-id');
    const variantIndex = parseInt(li.getAttribute('data-variant-index'), 10);

    if (!id || isNaN(variantIndex) || !cart[id] || !cart[id][variantIndex]) return;

    if (target.classList.contains('increment')) {
      cart[id][variantIndex].qty++;
    } else if (target.classList.contains('decrement')) {
      cart[id][variantIndex].qty--;
      if (cart[id][variantIndex].qty <= 0) {
        // Remove this variant
        cart[id].splice(variantIndex, 1);
        if (cart[id].length === 0) {
          delete cart[id];
        }
      }
    }
    saveCart();
    updateCartBadge();
    renderCart();
    renderMenu();
  }

  // Process cart order and show alert with details (for demo purposes)
  function handleCartOrderClick() {
    let totalQuantity = 0;
    let totalPrice = 0;
    const orderedItems = [];

    for (const id in cart) {
      const item = menuItems.find(i => i.id === id);
      if (!item) continue;

      cart[id].forEach(variant => {
        if (variant.qty <= 0) return;

        totalQuantity += variant.qty;

        const addonNames = Object.keys(variant.addons || {})
          .filter(addon => variant.addons[addon])
          .map(addon => addons[addon]?.name || addon);
        const addonPrice = Object.keys(variant.addons || {})
          .filter(addon => variant.addons[addon])
          .reduce((sum, addon) => sum + (addons[addon]?.price || 0), 0);

        const variantTotalPrice = (item.price + addonPrice) * variant.qty;
        totalPrice += variantTotalPrice;

        orderedItems.push({
          item,
          qty: variant.qty,
          addons: variant.addons
        });
      });
    }

    if (totalQuantity === 0) {
      alert('Ваша корзина пуста. Добавьте товары.');
      return;
    }

    // Show a simple alert summary for demo purposes
    let summary = `Вы заказали ${totalQuantity} позицию(й).\n\n`;
    orderedItems.forEach(({ item, qty, addons }) => {
      const addonNames = Object.keys(addons || {})
        .filter(addon => addons[addon])
        .map(addon => addons[addon] ? addons[addon] : null)
        .filter(Boolean)
      const names = Object.keys(addons).filter(k => addons[k]).map(k => addons[k]).join(', ');
      const addonText = addonNames.length > 0 ? ` + [${Object.keys(addons).filter(k => addons[k]).map(k => addons[k]).join(', ')}]` : '';
      summary += `${item.name} x${qty}${addonText}\n`;
    });
    summary += `\nИтого: ${totalPrice} ₽\n\nСпасибо за покупку!`;

    alert(summary);

    clearCart();
  }

  // Initialize the application
  function init() {
    loadCart();
    loadCurrentSelection();
    updateCartBadge();
    renderMenu();
    renderCart();

    menuList.addEventListener('click', handleMenuButtonClick);
    cartList.addEventListener('click', handleCartListClick);
    cartOrderBtn.addEventListener('click', handleCartOrderClick);
  }

  window.onload = init;
</script>
</body>
</html>
